services:
  gateway:
    image: ${DEPLOY_IMAGE:-ghcr.io/edwinux/didww-otp:latest}
    build: .
    container_name: didww-otp-gateway
    ports:
      - "8080:8080"
      - "5060:5060/udp"
      - "10000-10020:10000-10020/udp"
    environment:
      - DIDWW_SIP_HOST=${DIDWW_SIP_HOST}
      - DIDWW_USERNAME=${DIDWW_USERNAME}
      - DIDWW_PASSWORD=${DIDWW_PASSWORD}
      - DIDWW_CALLER_ID=${DIDWW_CALLER_ID}
      - DIDWW_CALLER_ID_US_CA=${DIDWW_CALLER_ID_US_CA:-}
      - PUBLIC_IP=${PUBLIC_IP}
      - API_SECRET=${API_SECRET}
      - HTTP_PORT=8080
      - SIP_PORT=5060
      - RTP_PORT_START=10000
      - RTP_PORT_END=10020
      - LOG_LEVEL=${LOG_LEVEL:-info}
      # Database
      - DATABASE_PATH=/data/otp.db
      # SMS
      - SMS_ENABLED=${SMS_ENABLED:-true}
      - SMS_MESSAGE_TEMPLATE=${SMS_MESSAGE_TEMPLATE:-Your verification code is: {code}}
      # Fraud detection
      - FRAUD_ENABLED=${FRAUD_ENABLED:-true}
      - FRAUD_SHADOW_BAN_THRESHOLD=${FRAUD_SHADOW_BAN_THRESHOLD:-50}
      - FRAUD_RATE_LIMIT_HOUR=${FRAUD_RATE_LIMIT_HOUR:-3}
      # ASN Database (fraud detection)
      - ASN_ENABLED=${ASN_ENABLED:-true}
      - ASN_DATA_PATH=/data/asn.mmdb
      - ASN_SHADOW_BAN_UNRESOLVED=${ASN_SHADOW_BAN_UNRESOLVED:-true}
      # Channels
      - CHANNELS_DEFAULT=${CHANNELS_DEFAULT:-sms,voice}
      - CHANNELS_ENABLE_FAILOVER=${CHANNELS_ENABLE_FAILOVER:-true}
      # Voice - use pre-recorded sounds instead of TTS
      - VOICE_USE_PRERECORDED_SOUNDS=${VOICE_USE_PRERECORDED_SOUNDS:-false}
    env_file:
      - .env
    volumes:
      # Persistent database storage
      - ./data:/data
      # Pre-recorded sound files for OTP playback
      - ./sounds/converted:/var/lib/asterisk/sounds/custom:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:8080/health"]
      interval: 30s
      timeout: 5s
      retries: 3
